{"version":"tree-0.1","tree":{"id":"App","path":"","constructInfo":{"fqn":"aws-cdk-lib.App","version":"2.214.0"},"children":{"SociIndexBuildIntegTest":{"id":"SociIndexBuildIntegTest","path":"SociIndexBuildIntegTest","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.214.0"},"children":{"Image1":{"id":"Image1","path":"SociIndexBuildIntegTest/Image1","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Image":{"id":"Image","path":"SociIndexBuildIntegTest/Image1/Image","constructInfo":{"fqn":"aws-cdk-lib.aws_ecr_assets.DockerImageAsset","version":"2.214.0"},"children":{"Staging":{"id":"Staging","path":"SociIndexBuildIntegTest/Image1/Image/Staging","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.214.0"}},"Repository":{"id":"Repository","path":"SociIndexBuildIntegTest/Image1/Image/Repository","constructInfo":{"fqn":"aws-cdk-lib.aws_ecr.RepositoryBase","version":"2.214.0","metadata":[]}}}},"Index":{"id":"Index","path":"SociIndexBuildIntegTest/Image1/Index","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"CustomResourceHandler":{"id":"CustomResourceHandler","path":"SociIndexBuildIntegTest/Image1/Index/CustomResourceHandler","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.SingletonFunction","version":"2.214.0","metadata":[{"runtime":"*","code":"*","handler":"*","uuid":"*","lambdaPurpose":"*","timeout":"*"}]}},"Project":{"id":"Project","path":"SociIndexBuildIntegTest/Image1/Index/Project","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/Image1/Index/Resource","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"2.214.0","metadata":["*","*","*"]},"children":{"Default":{"id":"Default","path":"SociIndexBuildIntegTest/Image1/Index/Resource/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.214.0"}}}}}}}},"DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3":{"id":"DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.Function","version":"2.214.0","metadata":[{"runtime":"*","code":"*","handler":"*","timeout":"*"}]},"children":{"ServiceRole":{"id":"ServiceRole","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/ServiceRole","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.214.0","metadata":[{"assumedBy":{"principalAccount":"*","assumeRoleAction":"*"},"managedPolicies":[{"managedPolicyArn":"*"}]},{"addToPrincipalPolicy":[{}]},{"attachInlinePolicy":["*"]},{"attachInlinePolicy":["*"]},{"addToPrincipalPolicy":[{}]}]},"children":{"ImportServiceRole":{"id":"ImportServiceRole","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/ServiceRole/ImportServiceRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.214.0","metadata":["*"]}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/ServiceRole/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"}}],"Version":"2012-10-17"},"managedPolicyArns":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"]]}]}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/ServiceRole/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.214.0","metadata":["*",{"attachToRole":["*"]},{"attachToRole":["*"]},{"addStatements":[{}]},{"addStatements":[{}]}]},"children":{"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/ServiceRole/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":"codebuild:StartBuild","Effect":"Allow","Resource":{"Fn::GetAtt":["SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd6470130487","Arn"]}}],"Version":"2012-10-17"},"policyName":"DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3ServiceRoleDefaultPolicyFECC51DC","roles":[{"Ref":"DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3ServiceRoleB008BAA4"}]}}}}}}},"Code":{"id":"Code","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/Code","constructInfo":{"fqn":"aws-cdk-lib.aws_s3_assets.Asset","version":"2.214.0"},"children":{"Stage":{"id":"Stage","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/Code/Stage","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.214.0"}},"AssetBucket":{"id":"AssetBucket","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/Code/AssetBucket","constructInfo":{"fqn":"aws-cdk-lib.aws_s3.BucketBase","version":"2.214.0","metadata":[]}}}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.CfnFunction","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Lambda::Function","aws:cdk:cloudformation:props":{"code":{"s3Bucket":{"Fn::Sub":"cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"},"s3Key":"b31e00a71ec5a9e3589df0e6879037cb1dcafee2e079c062e2c8eb891ba98b74.zip"},"handler":"index.handler","role":{"Fn::GetAtt":["DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3ServiceRoleB008BAA4","Arn"]},"runtime":"nodejs22.x","timeout":300}}},"LogGroup":{"id":"LogGroup","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/LogGroup","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.LogGroup","version":"2.214.0","metadata":[{"logGroupName":"*"}]},"children":{"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f3/LogGroup/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_logs.CfnLogGroup","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::Logs::LogGroup","aws:cdk:cloudformation:props":{"logGroupName":{"Fn::Join":["",["/aws/lambda/",{"Ref":"DeployTimeBuildCustomResourceHandlerdb740fd554364a848a09e6dfcd01f4f306AEFF37"}]]},"retentionInDays":731}}}}}}},"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64":{"id":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64","constructInfo":{"fqn":"aws-cdk-lib.aws_codebuild.Project","version":"2.214.0","metadata":[{"environment":{"buildImage":{"type":"*","defaultComputeType":"BUILD_GENERAL1_SMALL","imageId":"*","imagePullPrincipalType":"CODEBUILD","secretsManagerCredentials":"*","repository":"*"}},"buildSpec":"*"}]},"children":{"Role":{"id":"Role","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Role","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Role","version":"2.214.0","metadata":[{"roleName":"*","assumedBy":{"principalAccount":"*","assumeRoleAction":"*"}},{"addToPrincipalPolicy":[{}]},{"attachInlinePolicy":["*"]},{"attachInlinePolicy":["*"]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]},{"addToPrincipalPolicy":[{}]}]},"children":{"ImportRole":{"id":"ImportRole","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Role/ImportRole","constructInfo":{"fqn":"aws-cdk-lib.Resource","version":"2.214.0","metadata":["*"]}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Role/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnRole","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Role","aws:cdk:cloudformation:props":{"assumeRolePolicyDocument":{"Statement":[{"Action":"sts:AssumeRole","Effect":"Allow","Principal":{"Service":"codebuild.amazonaws.com"}}],"Version":"2012-10-17"}}}},"DefaultPolicy":{"id":"DefaultPolicy","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Role/DefaultPolicy","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.Policy","version":"2.214.0","metadata":["*",{"attachToRole":["*"]},{"attachToRole":["*"]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]},{"addStatements":[{}]}]},"children":{"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Role/DefaultPolicy/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_iam.CfnPolicy","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::IAM::Policy","aws:cdk:cloudformation:props":{"policyDocument":{"Statement":[{"Action":["logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Effect":"Allow","Resource":[{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":logs:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":log-group:/aws/codebuild/",{"Ref":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd6470130487"},":*"]]},{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":logs:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":log-group:/aws/codebuild/",{"Ref":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd6470130487"}]]}]},{"Action":["codebuild:BatchPutCodeCoverages","codebuild:BatchPutTestCases","codebuild:CreateReport","codebuild:CreateReportGroup","codebuild:UpdateReport"],"Effect":"Allow","Resource":{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":codebuild:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":report-group/",{"Ref":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd6470130487"},"-*"]]}},{"Action":["ecr:BatchCheckLayerAvailability","ecr:BatchGetImage","ecr:CompleteLayerUpload","ecr:DescribeImages","ecr:GetDownloadUrlForLayer","ecr:InitiateLayerUpload","ecr:PutImage","ecr:UploadLayerPart"],"Effect":"Allow","Resource":{"Fn::Join":["",["arn:",{"Ref":"AWS::Partition"},":ecr:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":repository/",{"Fn::Sub":"cdk-hnb659fds-container-assets-${AWS::AccountId}-${AWS::Region}"}]]}},{"Action":"ecr:GetAuthorizationToken","Effect":"Allow","Resource":"*"}],"Version":"2012-10-17"},"policyName":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64RoleDefaultPolicyFDEF3662","roles":[{"Ref":"SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64Role01AC76E9"}]}}}}}}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64/Resource","constructInfo":{"fqn":"aws-cdk-lib.aws_codebuild.CfnProject","version":"2.214.0"},"attributes":{"aws:cdk:cloudformation:type":"AWS::CodeBuild::Project","aws:cdk:cloudformation:props":{"artifacts":{"type":"NO_ARTIFACTS"},"cache":{"type":"NO_CACHE"},"encryptionKey":"alias/aws/s3","environment":{"type":"LINUX_CONTAINER","image":"aws/codebuild/standard:7.0","imagePullCredentialsType":"CODEBUILD","privilegedMode":false,"computeType":"BUILD_GENERAL1_SMALL"},"serviceRole":{"Fn::GetAtt":["SociIndexV2Builde7e8a038e0e44f558114cdd6523ad08famd64Role01AC76E9","Arn"]},"source":{"type":"NO_SOURCE","buildSpec":"{\n  \"version\": \"0.2\",\n  \"phases\": {\n    \"build\": {\n      \"commands\": [\n        \"current_dir=$(pwd)\",\n        \"wget --quiet -O soci-wrapper.tar.gz https://github.com/tmokmss/soci-wrapper/releases/download/v0.2.8/soci-wrapper-v0.2.8-linux-amd64.tar.gz\",\n        \"tar -xvzf soci-wrapper.tar.gz\",\n        \"\",\n        \"export AWS_ACCOUNT=$(aws sts get-caller-identity --query \\\"Account\\\" --output text)\",\n        \"export REGISTRY_USER=AWS\",\n        \"export REGISTRY_PASSWORD=$(aws ecr get-login-password --region $AWS_REGION)\",\n        \"export REGISTRY=$AWS_ACCOUNT.dkr.ecr.$AWS_REGION.amazonaws.com\",\n        \"aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY\",\n        \"REPO_NAME=$repositoryName\",\n        \"IMAGE_TAG=$inputImageTag\",\n        \"DIGEST=$(aws ecr describe-images --repository-name $REPO_NAME --image-ids imageTag=$IMAGE_TAG --query imageDetails[0].imageDigest --output text)\",\n        \"./soci-wrapper --repo $REPO_NAME --digest $DIGEST --region $AWS_REGION --account $AWS_ACCOUNT --soci-version V2 --output-tag $outputImageTag\"\n      ]\n    },\n    \"post_build\": {\n      \"commands\": [\n        \"echo Build completed on `date`\",\n        \"\\nSTATUS='SUCCESS'\\nif [ $CODEBUILD_BUILD_SUCCEEDING -ne 1 ] # Test if the build is failing\\nthen\\nSTATUS='FAILED'\\nREASON=\\\"deploy-time-build failed. See CloudWatch Log stream for the detailed reason: \\nhttps://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups/log-group/\\\\$252Faws\\\\$252Fcodebuild\\\\$252F$projectName/log-events/$CODEBUILD_LOG_PATH\\\"\\nfi\\ncat <<EOF > payload.json\\n{\\n  \\\"StackId\\\": \\\"$stackId\\\",\\n  \\\"RequestId\\\": \\\"$requestId\\\",\\n  \\\"LogicalResourceId\\\":\\\"$logicalResourceId\\\",\\n  \\\"PhysicalResourceId\\\": \\\"$outputImageTag\\\",\\n  \\\"Status\\\": \\\"$STATUS\\\",\\n  \\\"Reason\\\": \\\"$REASON\\\",\\n  \\\"Data\\\": {\\n    \\\"outputImageTag\\\": \\\"$outputImageTag\\\"\\n  }\\n}\\nEOF\\ncurl -i -X PUT -H 'Content-Type:' -d \\\"@payload.json\\\" \\\"$responseURL\\\"\\n              \"\n      ]\n    }\n  }\n}"}}}}}},"Image2":{"id":"Image2","path":"SociIndexBuildIntegTest/Image2","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"Image":{"id":"Image","path":"SociIndexBuildIntegTest/Image2/Image","constructInfo":{"fqn":"aws-cdk-lib.aws_ecr_assets.DockerImageAsset","version":"2.214.0"},"children":{"Staging":{"id":"Staging","path":"SociIndexBuildIntegTest/Image2/Image/Staging","constructInfo":{"fqn":"aws-cdk-lib.AssetStaging","version":"2.214.0"}},"Repository":{"id":"Repository","path":"SociIndexBuildIntegTest/Image2/Image/Repository","constructInfo":{"fqn":"aws-cdk-lib.aws_ecr.RepositoryBase","version":"2.214.0","metadata":[]}}}},"Index":{"id":"Index","path":"SociIndexBuildIntegTest/Image2/Index","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"},"children":{"CustomResourceHandler":{"id":"CustomResourceHandler","path":"SociIndexBuildIntegTest/Image2/Index/CustomResourceHandler","constructInfo":{"fqn":"aws-cdk-lib.aws_lambda.SingletonFunction","version":"2.214.0","metadata":[{"runtime":"*","code":"*","handler":"*","uuid":"*","lambdaPurpose":"*","timeout":"*"}]}},"Project":{"id":"Project","path":"SociIndexBuildIntegTest/Image2/Index/Project","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"Resource":{"id":"Resource","path":"SociIndexBuildIntegTest/Image2/Index/Resource","constructInfo":{"fqn":"aws-cdk-lib.CustomResource","version":"2.214.0","metadata":["*","*","*"]},"children":{"Default":{"id":"Default","path":"SociIndexBuildIntegTest/Image2/Index/Resource/Default","constructInfo":{"fqn":"aws-cdk-lib.CfnResource","version":"2.214.0"}}}}}}}},"BootstrapVersion":{"id":"BootstrapVersion","path":"SociIndexBuildIntegTest/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.214.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"SociIndexBuildIntegTest/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.214.0"}}}},"Test":{"id":"Test","path":"Test","constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTest","version":"2.159.0-alpha.0"},"children":{"DefaultTest":{"id":"DefaultTest","path":"Test/DefaultTest","constructInfo":{"fqn":"@aws-cdk/integ-tests-alpha.IntegTestCase","version":"2.159.0-alpha.0"},"children":{"Default":{"id":"Default","path":"Test/DefaultTest/Default","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}},"DeployAssert":{"id":"DeployAssert","path":"Test/DefaultTest/DeployAssert","constructInfo":{"fqn":"aws-cdk-lib.Stack","version":"2.214.0"},"children":{"BootstrapVersion":{"id":"BootstrapVersion","path":"Test/DefaultTest/DeployAssert/BootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnParameter","version":"2.214.0"}},"CheckBootstrapVersion":{"id":"CheckBootstrapVersion","path":"Test/DefaultTest/DeployAssert/CheckBootstrapVersion","constructInfo":{"fqn":"aws-cdk-lib.CfnRule","version":"2.214.0"}}}}}}}},"Tree":{"id":"Tree","path":"Tree","constructInfo":{"fqn":"constructs.Construct","version":"10.4.2"}}}}}